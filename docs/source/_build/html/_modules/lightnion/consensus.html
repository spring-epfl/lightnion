

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>lightnion.consensus &mdash; Lightnion  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Lightnion
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Installation</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Lightnion</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>lightnion.consensus</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for lightnion.consensus</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">base64</span> <span class="k">import</span> <span class="n">b64encode</span><span class="p">,</span> <span class="n">b64decode</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">binascii</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="kn">import</span> <span class="nn">urllib.request</span>

<span class="kn">import</span> <span class="nn">lightnion</span> <span class="k">as</span> <span class="nn">lnn</span>
<span class="kn">from</span> <span class="nn">tools.keys</span> <span class="k">import</span> <span class="n">get_signing_keys_info</span>


<span class="c1"># TODO: remove extra (useless) checks/exceptions within this file</span>

<div class="viewcode-block" id="scrap"><a class="viewcode-back" href="../../lightnion.html#lightnion.consensus.scrap">[docs]</a><span class="k">def</span> <span class="nf">scrap</span><span class="p">(</span><span class="n">consensus</span><span class="p">,</span> <span class="n">end_of_field</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Consume lines upon matching a criterion.</span>

<span class="sd">        Returns (consensus-without-first-line, first-line)</span>
<span class="sd">            if end_of_field(first-line) returns True,</span>
<span class="sd">            else returns (consensus-with-first-line, None)</span>

<span class="sd">        :param bytes consensus: input which first line may be consumed</span>
<span class="sd">        :param function end_of_field: passed a line, returns True when no match</span>

<span class="sd">        :returns: a tuple (updated-consensus, next-field-or-None)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">consensus</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">consensus</span><span class="p">,</span> <span class="kc">None</span>

    <span class="n">line</span><span class="p">,</span> <span class="n">remaining</span> <span class="o">=</span> <span class="n">consensus</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">end_of_field</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">consensus</span><span class="p">,</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">remaining</span><span class="p">,</span> <span class="n">line</span></div>


<div class="viewcode-block" id="scrap_signature"><a class="viewcode-back" href="../../lightnion.html#lightnion.consensus.scrap_signature">[docs]</a><span class="k">def</span> <span class="nf">scrap_signature</span><span class="p">(</span><span class="n">consensus</span><span class="p">,</span> <span class="n">fix</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;SIGNATURE&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Consume a signature field if there is one to consume.</span>

<span class="sd">        :param bytes consensus: input which may start with a signature.</span>

<span class="sd">        :returns: a tuple (updated-consensus, signature-or-None)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">consensus</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;-----BEGIN &#39;</span> <span class="o">+</span> <span class="n">fix</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;-----&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">consensus</span><span class="p">,</span> <span class="kc">None</span>

    <span class="n">lines</span> <span class="o">=</span> <span class="n">consensus</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="mi">22</span><span class="p">)</span>  <span class="c1"># fits 0-1024o (for 256o sig)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">idx_endsig</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;-----END &#39;</span> <span class="o">+</span> <span class="n">fix</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;-----&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">consensus</span><span class="p">,</span> <span class="kc">None</span>

    <span class="n">remaining</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">idx_endsig</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:])</span>
    <span class="n">content</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">idx_endsig</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">remaining</span><span class="p">,</span> <span class="n">content</span></div>


<div class="viewcode-block" id="parse_address"><a class="viewcode-back" href="../../lightnion.html#lightnion.consensus.parse_address">[docs]</a><span class="k">def</span> <span class="nf">parse_address</span><span class="p">(</span><span class="n">address</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Take a Tor-formatted v4 or v6 IP address with a port, returns a</span>
<span class="sd">        cleaned-up version.</span>

<span class="sd">        :param str address: input address to be processed</span>

<span class="sd">        :returns: a tuple (address, port, guessed-type) where port is an</span>
<span class="sd">                  integer and guessed-type is 4 or 6 (IPv4 or IPv6).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">address</span> <span class="o">=</span> <span class="n">address</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
    <span class="n">address</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="s1">&#39;:&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">address</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">address</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">guessed_type</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="k">if</span> <span class="n">address</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">):</span>
        <span class="n">address</span> <span class="o">=</span> <span class="n">address</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">guessed_type</span> <span class="o">=</span> <span class="mi">6</span>
    <span class="k">if</span> <span class="n">address</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">guessed_type</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">address</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s1">&#39;Seems like an invalid IPv6: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">address</span><span class="p">))</span>
        <span class="n">address</span> <span class="o">=</span> <span class="n">address</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">guessed_type</span> <span class="o">=</span> <span class="mi">6</span>
    <span class="k">if</span> <span class="n">address</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">guessed_type</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s1">&#39;Seems like an very odd IPv6: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">address</span><span class="p">))</span>
        <span class="n">guessed_type</span> <span class="o">=</span> <span class="mi">6</span>

    <span class="k">return</span> <span class="n">address</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">port</span><span class="p">),</span> <span class="n">guessed_type</span></div>


<div class="viewcode-block" id="parse_range_once"><a class="viewcode-back" href="../../lightnion.html#lightnion.consensus.parse_range_once">[docs]</a><span class="k">def</span> <span class="nf">parse_range_once</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Take Tor-formatted ranges, then returns it as a list of integers if</span>
<span class="sd">        expanded or a mix of integers and ranges as [low, high] tuples.</span>

<span class="sd">        For example, we use it to parse &quot;p&quot; fields:</span>
<span class="sd">            https://github.com/plcp/tor-scripts/blob/master/torspec/dir-spec-4d0d42f.txt#L2322</span>

<span class="sd">        :param str value: input value to be processed</span>
<span class="sd">        :param bool expand: do we expand a range as integers? (default: True)</span>

<span class="sd">        :returns: a list of integers or a mix of integers and range list/tuples</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
    <span class="n">subvalues</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">subvalue</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;-&#39;</span> <span class="ow">in</span> <span class="n">subvalue</span><span class="p">:</span>
            <span class="n">low</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">subvalue</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">expand</span><span class="p">:</span>
                <span class="n">subvalues</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">low</span> <span class="o">==</span> <span class="n">high</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">subvalues</span> <span class="o">+=</span> <span class="p">[</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">subvalues</span> <span class="o">+=</span> <span class="p">[[</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">subvalues</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">subvalue</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">subvalues</span></div>


<div class="viewcode-block" id="parse_ranges"><a class="viewcode-back" href="../../lightnion.html#lightnion.consensus.parse_ranges">[docs]</a><span class="k">def</span> <span class="nf">parse_ranges</span><span class="p">(</span><span class="n">ranges</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Take Tor-formatted named ranges, then returns a keyword-based</span>
<span class="sd">        dictionary of list of integers or mix of integers and range tuples (as</span>
<span class="sd">        returned by parse_range_once), expanded or not.</span>

<span class="sd">        For example, we use it to parse &quot;recommended-client-protocols&quot; fields:</span>
<span class="sd">            https://github.com/plcp/tor-scripts/blob/master/torspec/dir-spec-4d0d42f.txt#L780</span>

<span class="sd">        :param str ranges: input ranges to be processed</span>
<span class="sd">        :param bool expand: do we expand ranges as integers? (default: True)</span>

<span class="sd">        :returns: a dictionary with (range-name, range-content) items</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pairs</span> <span class="o">=</span> <span class="n">ranges</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
    <span class="n">content</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">[</span><span class="n">pair</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">pairs</span> <span class="k">if</span> <span class="s1">&#39;=&#39;</span> <span class="ow">in</span> <span class="n">pair</span><span class="p">]:</span>
        <span class="n">content</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">parse_range_once</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">expand</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">content</span></div>


<div class="viewcode-block" id="parse_params"><a class="viewcode-back" href="../../lightnion.html#lightnion.consensus.parse_params">[docs]</a><span class="k">def</span> <span class="nf">parse_params</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Take Tor-formatted parameters, then returns a keyword-based dictionary</span>
<span class="sd">        of integers.</span>

<span class="sd">        For example, we use it to parse &quot;params&quot; fields:</span>
<span class="sd">            https://github.com/plcp/tor-scripts/blob/master/torspec/dir-spec-4d0d42f.txt#L1820</span>

<span class="sd">        :param str params: input params to be processed</span>

<span class="sd">        :returns: a dictionary with (param-name, param-integer-value) items</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pairs</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
    <span class="n">content</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">[</span><span class="n">pair</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">]:</span>
        <span class="n">content</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">content</span></div>


<div class="viewcode-block" id="parse_fingerprint"><a class="viewcode-back" href="../../lightnion.html#lightnion.consensus.parse_fingerprint">[docs]</a><span class="k">def</span> <span class="nf">parse_fingerprint</span><span class="p">(</span><span class="n">payload</span><span class="p">):</span>
    <span class="n">asbytes</span> <span class="o">=</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
    <span class="n">fingers</span> <span class="o">=</span> <span class="n">asbytes</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="n">fingers</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">fingers</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">fingers</span><span class="p">),</span> <span class="mi">4</span><span class="p">)])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">fingers</span> <span class="o">==</span> <span class="n">payload</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="s1">&#39;Fingerprint not conform: </span><span class="si">{}</span><span class="s1"> vs </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fingers</span><span class="p">,</span> <span class="n">payload</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">fingers</span></div>


<div class="viewcode-block" id="parse_base64"><a class="viewcode-back" href="../../lightnion.html#lightnion.consensus.parse_base64">[docs]</a><span class="k">def</span> <span class="nf">parse_base64</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">decode</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Take an input base64 string, decode it, re-encode it.</span>

<span class="sd">        For example, we use it to parse &quot;shared-rand-current-value&quot; fields:</span>
<span class="sd">            https://github.com/plcp/tor-scripts/blob/master/torspec/dir-spec-4d0d42f.txt#L2069</span>

<span class="sd">        :param str payload: input base64-encoded data</span>
<span class="sd">        :param bool decode: return raw bytes (default: False)</span>

<span class="sd">        :returns: a base64-encoded string equivalent to the input</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">decoded</span> <span class="o">=</span> <span class="n">b64decode</span><span class="p">(</span><span class="n">payload</span> <span class="o">+</span> <span class="s1">&#39;====&#39;</span><span class="p">)</span>
    <span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">b64encode</span><span class="p">(</span><span class="n">decoded</span><span class="p">),</span> <span class="s1">&#39;utf8&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">payload</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">value</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="n">payload</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span> <span class="o">==</span> <span class="n">payload</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Invalid base64 encoding: </span><span class="si">{}</span><span class="s1"> vs </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">value</span><span class="p">,</span> <span class="n">payload</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">decode</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">decoded</span>

    <span class="k">return</span> <span class="n">value</span></div>


<div class="viewcode-block" id="parse_time"><a class="viewcode-back" href="../../lightnion.html#lightnion.consensus.parse_time">[docs]</a><span class="k">def</span> <span class="nf">parse_time</span><span class="p">(</span><span class="n">timedate</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Take a Tor-formatted (Y-m-d H:M:S) time, parse it, then returns the</span>
<span class="sd">        corresponding date, time and datetime object. This function assumes</span>
<span class="sd">        that the given time uses the UTC timezone – as it&#39;s the timezone used</span>
<span class="sd">        into Tor consensuses.</span>

<span class="sd">        :param str timedate: input time and date to be parsed</span>

<span class="sd">        :returns: a tuple (date-str, time-str, datetime-object)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">when</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">timedate</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span>

    <span class="c1"># convert to UTC-aware datetime object</span>
    <span class="n">when</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="o">*</span><span class="n">when</span><span class="o">.</span><span class="n">timetuple</span><span class="p">()[:</span><span class="mi">6</span><span class="p">],</span>
                             <span class="n">tzinfo</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">when</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">),</span> <span class="n">when</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%H:%M:%S&#39;</span><span class="p">),</span> <span class="n">when</span><span class="p">)</span></div>


<div class="viewcode-block" id="consume_http"><a class="viewcode-back" href="../../lightnion.html#lightnion.consensus.consume_http">[docs]</a><span class="k">def</span> <span class="nf">consume_http</span><span class="p">(</span><span class="n">consensus</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Consume HTTP headers if present, then returns the remaining input to be</span>
<span class="sd">        further processed and a set of headers (or None, if none present).</span>

<span class="sd">        :param str consensus: input to be processed</span>

<span class="sd">        :returns: a tuple (remaining-input, headers-or-None)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">end_of_field</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">line</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="o">!=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span>

    <span class="n">fields</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">headers</span><span class="o">=</span><span class="nb">dict</span><span class="p">())</span>
    <span class="n">valid</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">consensus</span><span class="p">,</span> <span class="n">header</span> <span class="o">=</span> <span class="n">scrap</span><span class="p">(</span><span class="n">consensus</span><span class="p">,</span> <span class="n">end_of_field</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">header</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">consensus</span><span class="p">,</span> <span class="n">fields</span> <span class="k">if</span> <span class="n">valid</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="n">valid</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="sa">b</span><span class="s1">&#39; &#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">header</span> <span class="o">=</span> <span class="n">header</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">header</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="s1">&#39;utf8&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">header</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;HTTP/&#39;</span><span class="p">):</span>
            <span class="n">version</span><span class="p">,</span> <span class="n">fields</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">],</span> <span class="n">_</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">fields</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">version</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">keyword</span><span class="p">,</span> <span class="n">content</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">keyword</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;:&#39;</span><span class="p">:</span>
            <span class="n">fields</span><span class="p">[</span><span class="s1">&#39;headers&#39;</span><span class="p">][</span><span class="n">keyword</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">content</span></div>


<div class="viewcode-block" id="consume_headers"><a class="viewcode-back" href="../../lightnion.html#lightnion.consensus.consume_headers">[docs]</a><span class="k">def</span> <span class="nf">consume_headers</span><span class="p">(</span><span class="n">consensus</span><span class="p">,</span> <span class="n">flavor</span><span class="o">=</span><span class="s1">&#39;unflavored&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Consume consensus headers if present, then returns the remaining input</span>
<span class="sd">        to be further processed and a set of headers (or None, if none</span>
<span class="sd">        present).</span>

<span class="sd">        Will consume the following fields:</span>
<span class="sd">            - network-status-version</span>
<span class="sd">            - vote-status</span>
<span class="sd">            - consensus-method</span>
<span class="sd">            - valid-after</span>
<span class="sd">            - fresh-until</span>
<span class="sd">            - valid-until</span>
<span class="sd">            - voting-delay</span>
<span class="sd">            - client-versions</span>
<span class="sd">            - server-versions</span>
<span class="sd">            - known-flags</span>
<span class="sd">            - recommended-client-protocols</span>
<span class="sd">            - recommended-relay-protocols</span>
<span class="sd">            - required-client-protocols</span>
<span class="sd">            - required-relay-protocols</span>
<span class="sd">            - params</span>
<span class="sd">            - shared-rand-previous-value</span>
<span class="sd">            - shared-rand-current-value</span>

<span class="sd">        :param str consensus: input to be processed</span>
<span class="sd">        :param str flavor: consensus flavor (&#39;unflavored&#39; or &#39;microdesc&#39;)</span>

<span class="sd">        :returns: a tuple (remaining-input, headers-or-None)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">flavor</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;unflavored&#39;</span><span class="p">,</span> <span class="s1">&#39;microdesc&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s1">&#39;Consensus flavor &quot;</span><span class="si">{}</span><span class="s1">&quot; not supported.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flavor</span><span class="p">))</span>

    <span class="n">whitelist</span> <span class="o">=</span> <span class="p">[</span>
        <span class="sa">b</span><span class="s1">&#39;network-status-version&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;vote-status&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;consensus-method&#39;</span><span class="p">,</span>
        <span class="sa">b</span><span class="s1">&#39;valid-after&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;fresh-until&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;valid-until&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;voting-delay&#39;</span><span class="p">,</span>
        <span class="sa">b</span><span class="s1">&#39;client-versions&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;server-versions&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;known-flags&#39;</span><span class="p">,</span>
        <span class="sa">b</span><span class="s1">&#39;recommended-client-protocols&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;recommended-relay-protocols&#39;</span><span class="p">,</span>
        <span class="sa">b</span><span class="s1">&#39;required-client-protocols&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;required-relay-protocols&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;params&#39;</span><span class="p">,</span>
        <span class="sa">b</span><span class="s1">&#39;shared-rand-previous-value&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;shared-rand-current-value&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">end_of_field</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
        <span class="k">if</span> <span class="sa">b</span><span class="s1">&#39; &#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="n">keyword</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">keyword</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">whitelist</span>

    <span class="n">fields</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">valid</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">consensus</span><span class="p">,</span> <span class="n">header</span> <span class="o">=</span> <span class="n">scrap</span><span class="p">(</span><span class="n">consensus</span><span class="p">,</span> <span class="n">end_of_field</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">header</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">consensus</span><span class="p">,</span> <span class="n">fields</span> <span class="k">if</span> <span class="n">valid</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="n">valid</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="sa">b</span><span class="s1">&#39; &#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">header</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="s1">&#39;utf8&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">keyword</span><span class="p">,</span> <span class="n">content</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">keyword</span> <span class="o">==</span> <span class="s1">&#39;network-status-version&#39;</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">content</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;unflavored&#39;</span><span class="p">)</span>
            <span class="n">version</span><span class="p">,</span> <span class="n">variant</span> <span class="o">=</span> <span class="n">content</span>
            <span class="n">content</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">version</span><span class="p">),</span> <span class="n">flavor</span><span class="o">=</span><span class="n">variant</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Expecting </span><span class="si">{}</span><span class="s1"> as first field: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">keyword</span><span class="p">,</span> <span class="n">content</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">content</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Expecting </span><span class="si">{}</span><span class="s1"> version &gt;= 3 here: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">keyword</span><span class="p">,</span> <span class="n">content</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">content</span><span class="p">[</span><span class="s1">&#39;flavor&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">flavor</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Unmatched </span><span class="si">{}</span><span class="s1"> flavor </span><span class="si">{}</span><span class="s1"> here: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">keyword</span><span class="p">,</span> <span class="n">flavor</span><span class="p">,</span> <span class="n">content</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">keyword</span> <span class="o">==</span> <span class="s1">&#39;consensus-method&#39;</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">content</span> <span class="o">&gt;=</span> <span class="mi">26</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="s1">&#39;Consensus version &gt;= 26 required: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">content</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;valid-after&#39;</span><span class="p">,</span> <span class="s1">&#39;fresh-until&#39;</span><span class="p">,</span> <span class="s1">&#39;valid-until&#39;</span><span class="p">]:</span>
            <span class="n">date</span><span class="p">,</span> <span class="n">time_parsed</span><span class="p">,</span> <span class="n">when</span> <span class="o">=</span> <span class="n">parse_time</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
            <span class="n">content</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">date</span><span class="o">=</span><span class="n">date</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">time_parsed</span><span class="p">,</span> <span class="n">stamp</span><span class="o">=</span><span class="n">when</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span>

            <span class="k">if</span> <span class="n">keyword</span> <span class="o">==</span> <span class="s1">&#39;valid-after&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">content</span><span class="p">[</span><span class="s1">&#39;stamp&#39;</span><span class="p">]:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> not yet valid! </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">keyword</span><span class="p">,</span> <span class="n">content</span><span class="p">))</span>  <span class="c1"># valid-after</span>

            <span class="k">if</span> <span class="n">keyword</span> <span class="o">==</span> <span class="s1">&#39;fresh-until&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">content</span><span class="p">[</span><span class="s1">&#39;stamp&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">fields</span><span class="p">[</span><span class="s1">&#39;valid-after&#39;</span><span class="p">][</span><span class="s1">&#39;stamp&#39;</span><span class="p">]:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> not fresh! </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">keyword</span><span class="p">,</span> <span class="n">content</span><span class="p">))</span>  <span class="c1"># fresh-until</span>

            <span class="k">if</span> <span class="n">keyword</span> <span class="o">==</span> <span class="s1">&#39;valid-until&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">content</span><span class="p">[</span><span class="s1">&#39;stamp&#39;</span><span class="p">]:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> no more valid! </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">keyword</span><span class="p">,</span> <span class="n">content</span><span class="p">))</span>  <span class="c1"># valid-until</span>

        <span class="k">if</span> <span class="n">keyword</span> <span class="o">==</span> <span class="s1">&#39;voting-delay&#39;</span><span class="p">:</span>
            <span class="n">vote</span><span class="p">,</span> <span class="n">dist</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">content</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">vote</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">vote</span><span class="p">),</span> <span class="n">dist</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">dist</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;client-versions&#39;</span><span class="p">,</span> <span class="s1">&#39;server-versions&#39;</span><span class="p">]:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">keyword</span> <span class="o">==</span> <span class="s1">&#39;known-flags&#39;</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">keyword</span><span class="o">.</span><span class="n">startswith</span><span class="p">((</span><span class="s1">&#39;recommended&#39;</span><span class="p">,</span> <span class="s1">&#39;required&#39;</span><span class="p">)):</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">parse_ranges</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">keyword</span> <span class="o">==</span> <span class="s1">&#39;params&#39;</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">parse_params</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">keyword</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;shared-rand&#39;</span><span class="p">):</span>
            <span class="n">reveals</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>

            <span class="n">value</span> <span class="o">=</span> <span class="n">parse_base64</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">content</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;NumReveals&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">reveals</span><span class="p">),</span> <span class="s1">&#39;Value&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">}</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">content</span><span class="p">[</span><span class="s1">&#39;NumReveals&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> must be &gt;= 0 here: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">keyword</span><span class="p">,</span> <span class="n">content</span><span class="p">))</span>

        <span class="n">fields</span><span class="p">[</span><span class="n">keyword</span><span class="p">]</span> <span class="o">=</span> <span class="n">content</span></div>


<div class="viewcode-block" id="consume_dir_sources"><a class="viewcode-back" href="../../lightnion.html#lightnion.consensus.consume_dir_sources">[docs]</a><span class="k">def</span> <span class="nf">consume_dir_sources</span><span class="p">(</span><span class="n">consensus</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Consume directory source listing if present, then returns the remaining</span>
<span class="sd">        input to be further processed and a set of directory sources (or None,</span>
<span class="sd">        if none present).</span>

<span class="sd">        Will consume the following fields:</span>
<span class="sd">            - dir-source</span>
<span class="sd">            - contact</span>
<span class="sd">            - vote-digest</span>

<span class="sd">        :param str consensus: input to be processed</span>

<span class="sd">        :returns: a tuple (remaining-input, headers-or-None)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">whitelist</span> <span class="o">=</span> <span class="p">[</span><span class="sa">b</span><span class="s1">&#39;dir-source&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;contact&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;vote-digest&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">end_of_field</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
        <span class="k">if</span> <span class="sa">b</span><span class="s1">&#39; &#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="n">keyword</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">keyword</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">whitelist</span>

    <span class="n">fields</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">valid</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">consensus</span><span class="p">,</span> <span class="n">header</span> <span class="o">=</span> <span class="n">scrap</span><span class="p">(</span><span class="n">consensus</span><span class="p">,</span> <span class="n">end_of_field</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">header</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">valid</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">consensus</span><span class="p">,</span> <span class="kc">None</span>
            <span class="k">break</span>

        <span class="n">valid</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="sa">b</span><span class="s1">&#39; &#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">header</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="s1">&#39;utf8&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">keyword</span><span class="p">,</span> <span class="n">content</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">keyword</span> <span class="o">==</span> <span class="s1">&#39;vote-digest&#39;</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">content</span><span class="p">)</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">content</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Unmatched </span><span class="si">{}</span><span class="s1"> here: </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">keyword</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">content</span><span class="p">))</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">if</span> <span class="n">keyword</span> <span class="o">==</span> <span class="s1">&#39;dir-source&#39;</span><span class="p">:</span>
            <span class="n">nickname</span><span class="p">,</span> <span class="n">identity</span><span class="p">,</span> <span class="n">hostname</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">dirport</span><span class="p">,</span> <span class="n">orport</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

            <span class="n">value</span> <span class="o">=</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">identity</span><span class="p">)</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">identity</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Unmatched </span><span class="si">{}</span><span class="s1"> here: </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">keyword</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">content</span><span class="p">))</span>
            <span class="n">identity</span> <span class="o">=</span> <span class="n">value</span>

            <span class="n">content</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">nickname</span><span class="o">=</span><span class="n">nickname</span><span class="p">,</span> <span class="n">identity</span><span class="o">=</span><span class="n">identity</span><span class="p">,</span>
                           <span class="n">hostname</span><span class="o">=</span><span class="n">hostname</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="n">address</span><span class="p">,</span> <span class="n">dirport</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">dirport</span><span class="p">),</span>
                           <span class="n">orport</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">orport</span><span class="p">))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">content</span><span class="p">[</span><span class="s1">&#39;dirport&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">65536</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Invalid dirport here: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">content</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">content</span><span class="p">[</span><span class="s1">&#39;orport&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">65536</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Invalid orport here: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">content</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">keyword</span> <span class="o">!=</span> <span class="s1">&#39;dir-source&#39;</span> <span class="ow">and</span> <span class="n">fields</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;dir-source&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">keyword</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]):</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="s1">&#39;Unexpected </span><span class="si">{}</span><span class="s1"> with: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">keyword</span><span class="p">,</span> <span class="n">fields</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">assert</span> <span class="n">keyword</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">fields</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">keyword</span><span class="p">]</span> <span class="o">=</span> <span class="n">content</span>
            <span class="k">continue</span>

        <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">keyword</span><span class="p">,</span> <span class="n">content</span><span class="p">))</span>

    <span class="n">full_entries_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">fields</span> <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;dir-source&#39;</span><span class="p">])</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">full_entries_count</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">fields</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Incomplete entry or corrupted?&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">full_entries_count</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">fields</span><span class="p">):</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">consensus</span><span class="p">,</span> <span class="n">fields</span></div>


<div class="viewcode-block" id="consume_routers"><a class="viewcode-back" href="../../lightnion.html#lightnion.consensus.consume_routers">[docs]</a><span class="k">def</span> <span class="nf">consume_routers</span><span class="p">(</span><span class="n">consensus</span><span class="p">,</span> <span class="n">flavor</span><span class="o">=</span><span class="s1">&#39;unflavored&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Consume router listing if present, then returns the remaining input to</span>
<span class="sd">        be further processed and a set of routers (or None, if none present).</span>

<span class="sd">        Will consume the following fields:</span>
<span class="sd">            - r</span>
<span class="sd">            - m</span>
<span class="sd">            - s</span>
<span class="sd">            - v</span>
<span class="sd">            - pr</span>
<span class="sd">            - w</span>
<span class="sd">            - p (unflavored only)</span>
<span class="sd">            - a (unflavored only)</span>

<span class="sd">        :param str consensus: input to be processed</span>
<span class="sd">        :param str flavor: consensus flavor (&#39;unflavored&#39; or &#39;microdesc&#39;)</span>

<span class="sd">        :returns: a tuple (remaining-input, headers-or-None)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">flavor</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;unflavored&#39;</span><span class="p">,</span> <span class="s1">&#39;microdesc&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s1">&#39;Consensus flavor &quot;</span><span class="si">{}</span><span class="s1">&quot; not supported.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flavor</span><span class="p">))</span>

    <span class="c1"># TODO: check if &#39;a&#39; fields in microdesc consensus are still a thing</span>
    <span class="k">if</span> <span class="n">flavor</span> <span class="o">==</span> <span class="s1">&#39;unflavored&#39;</span><span class="p">:</span>
        <span class="n">whitelist</span> <span class="o">=</span> <span class="p">[</span><span class="sa">b</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;pr&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">flavor</span> <span class="o">==</span> <span class="s1">&#39;microdesc&#39;</span><span class="p">:</span>
        <span class="n">whitelist</span> <span class="o">=</span> <span class="p">[</span><span class="sa">b</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;pr&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="p">]</span>

    <span class="n">aliases</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">m</span><span class="o">=</span><span class="s1">&#39;micro-digest&#39;</span><span class="p">,</span> <span class="n">pr</span><span class="o">=</span><span class="s1">&#39;protocols&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="s1">&#39;flags&#39;</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="s1">&#39;version&#39;</span><span class="p">,</span>
                   <span class="n">p</span><span class="o">=</span><span class="s1">&#39;exit-policy&#39;</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="s1">&#39;or-address&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">end_of_field</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
        <span class="k">if</span> <span class="sa">b</span><span class="s1">&#39; &#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="n">keyword</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">keyword</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">whitelist</span>

    <span class="n">fields</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">valid</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">consensus</span><span class="p">,</span> <span class="n">header</span> <span class="o">=</span> <span class="n">scrap</span><span class="p">(</span><span class="n">consensus</span><span class="p">,</span> <span class="n">end_of_field</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">header</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">valid</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">consensus</span><span class="p">,</span> <span class="kc">None</span>
            <span class="k">break</span>

        <span class="n">valid</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="sa">b</span><span class="s1">&#39; &#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">header</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="s1">&#39;utf8&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">keyword</span><span class="p">,</span> <span class="n">content</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">keyword</span> <span class="o">==</span> <span class="s1">&#39;m&#39;</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">parse_base64</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">keyword</span> <span class="o">==</span> <span class="s1">&#39;s&#39;</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">keyword</span> <span class="o">==</span> <span class="s1">&#39;pr&#39;</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">parse_ranges</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">keyword</span> <span class="o">==</span> <span class="s1">&#39;w&#39;</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">parse_params</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">keyword</span> <span class="o">==</span> <span class="s1">&#39;p&#39;</span><span class="p">:</span>
            <span class="n">policy_type</span><span class="p">,</span> <span class="n">portlist</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">policy_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;accept&#39;</span><span class="p">,</span> <span class="s1">&#39;reject&#39;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Unknown policy: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">policy_type</span><span class="p">))</span>

            <span class="n">portlist</span> <span class="o">=</span> <span class="n">parse_range_once</span><span class="p">(</span><span class="n">portlist</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">content</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">policy_type</span><span class="p">,</span> <span class="s1">&#39;PortList&#39;</span><span class="p">:</span> <span class="n">portlist</span><span class="p">}</span>

        <span class="k">if</span> <span class="n">keyword</span> <span class="o">==</span> <span class="s1">&#39;a&#39;</span><span class="p">:</span>
            <span class="n">address</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">guessed_type</span> <span class="o">=</span> <span class="n">parse_address</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
            <span class="n">content</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;ip&#39;</span><span class="p">:</span> <span class="n">address</span><span class="p">,</span> <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="n">port</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">guessed_type</span><span class="p">}]</span>

        <span class="k">if</span> <span class="n">keyword</span> <span class="o">==</span> <span class="s1">&#39;r&#39;</span> <span class="ow">and</span> <span class="n">flavor</span> <span class="o">==</span> <span class="s1">&#39;unflavored&#39;</span><span class="p">:</span>
            <span class="p">(</span><span class="n">nickname</span><span class="p">,</span> <span class="n">identity</span><span class="p">,</span> <span class="n">digest</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">orport</span><span class="p">,</span>
             <span class="n">dirport</span><span class="p">)</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>

            <span class="n">digest</span> <span class="o">=</span> <span class="n">parse_base64</span><span class="p">(</span><span class="n">digest</span><span class="p">)</span>
            <span class="n">identity</span> <span class="o">=</span> <span class="n">parse_base64</span><span class="p">(</span><span class="n">identity</span><span class="p">)</span>
            <span class="n">date</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">when</span> <span class="o">=</span> <span class="n">parse_time</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">date</span><span class="p">,</span> <span class="n">time</span><span class="p">]))</span>

            <span class="n">content</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">nickname</span><span class="o">=</span><span class="n">nickname</span><span class="p">,</span> <span class="n">identity</span><span class="o">=</span><span class="n">identity</span><span class="p">,</span> <span class="n">digest</span><span class="o">=</span><span class="n">digest</span><span class="p">,</span>
                           <span class="n">date</span><span class="o">=</span><span class="n">date</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">,</span> <span class="n">stamp</span><span class="o">=</span><span class="n">when</span><span class="o">.</span><span class="n">timestamp</span><span class="p">(),</span> <span class="n">address</span><span class="o">=</span><span class="n">address</span><span class="p">,</span>
                           <span class="n">dirport</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">dirport</span><span class="p">),</span> <span class="n">orport</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">orport</span><span class="p">))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">content</span><span class="p">[</span><span class="s1">&#39;dirport&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">65536</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Invalid dirport here: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">content</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">content</span><span class="p">[</span><span class="s1">&#39;orport&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">65536</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Invalid orport here: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">content</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">keyword</span> <span class="o">==</span> <span class="s1">&#39;r&#39;</span> <span class="ow">and</span> <span class="n">flavor</span> <span class="o">==</span> <span class="s1">&#39;microdesc&#39;</span><span class="p">:</span>
            <span class="n">nickname</span><span class="p">,</span> <span class="n">identity</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">orport</span><span class="p">,</span> <span class="n">dirport</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

            <span class="n">identity</span> <span class="o">=</span> <span class="n">parse_base64</span><span class="p">(</span><span class="n">identity</span><span class="p">)</span>
            <span class="n">date</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">when</span> <span class="o">=</span> <span class="n">parse_time</span><span class="p">(</span><span class="n">date</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">time</span><span class="p">)</span>

            <span class="n">content</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">nickname</span><span class="o">=</span><span class="n">nickname</span><span class="p">,</span> <span class="n">identity</span><span class="o">=</span><span class="n">identity</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="n">date</span><span class="p">,</span>
                           <span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">,</span> <span class="n">stamp</span><span class="o">=</span><span class="n">when</span><span class="o">.</span><span class="n">timestamp</span><span class="p">(),</span> <span class="n">address</span><span class="o">=</span><span class="n">address</span><span class="p">,</span>
                           <span class="n">dirport</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">dirport</span><span class="p">),</span> <span class="n">orport</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">orport</span><span class="p">))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">content</span><span class="p">[</span><span class="s1">&#39;dirport&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">65536</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Invalid dirport here: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">content</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">content</span><span class="p">[</span><span class="s1">&#39;orport&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">65536</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Invalid orport here: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">content</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">keyword</span> <span class="o">!=</span> <span class="s1">&#39;r&#39;</span> <span class="ow">and</span> <span class="n">fields</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;r&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">aliases</span><span class="p">:</span>
                <span class="n">keyword</span> <span class="o">=</span> <span class="n">aliases</span><span class="p">[</span><span class="n">keyword</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">keyword</span> <span class="o">==</span> <span class="s1">&#39;or-address&#39;</span> <span class="ow">and</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">content</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;ignored&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">fields</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;or-address&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">content</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">keyword</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]):</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Unexpected </span><span class="si">{}</span><span class="s1"> with: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">keyword</span><span class="p">,</span>
                                                                   <span class="n">fields</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>

            <span class="n">fields</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">keyword</span><span class="p">]</span> <span class="o">=</span> <span class="n">content</span>
            <span class="k">continue</span>

        <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">keyword</span><span class="p">,</span> <span class="n">content</span><span class="p">))</span>

    <span class="n">full_entries_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">fields</span> <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;r&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">full_entries_count</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">fields</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Invalid or corrupted entry?&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">full_entries_count</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">fields</span><span class="p">):</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">consensus</span><span class="p">,</span> <span class="n">fields</span></div>


<div class="viewcode-block" id="consume_footer"><a class="viewcode-back" href="../../lightnion.html#lightnion.consensus.consume_footer">[docs]</a><span class="k">def</span> <span class="nf">consume_footer</span><span class="p">(</span><span class="n">consensus</span><span class="p">,</span> <span class="n">flavor</span><span class="o">=</span><span class="s1">&#39;unflavored&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Consume consensus footer if present, then returns the remaining input</span>
<span class="sd">        to be further processed and a set of footers (or None, if none</span>
<span class="sd">        present).</span>

<span class="sd">        Will consume the following fields:</span>
<span class="sd">            - directory-footer</span>
<span class="sd">            - bandwidth-weights</span>
<span class="sd">            - directory-signature</span>

<span class="sd">        :param str consensus: input to be processed</span>
<span class="sd">        :param str flavor: consensus flavor (&#39;unflavored&#39; or &#39;microdesc&#39;)</span>

<span class="sd">        :returns: a tuple (remaining-input, headers-or-None)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">flavor</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;unflavored&#39;</span><span class="p">,</span> <span class="s1">&#39;microdesc&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s1">&#39;Consensus flavor &quot;</span><span class="si">{}</span><span class="s1">&quot; not supported.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flavor</span><span class="p">))</span>

    <span class="n">whitelist</span> <span class="o">=</span> <span class="p">[</span>
        <span class="sa">b</span><span class="s1">&#39;directory-footer&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;bandwidth-weights&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;directory-signature&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">end_of_field</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
        <span class="k">if</span> <span class="sa">b</span><span class="s1">&#39;directory-footer&#39;</span> <span class="o">==</span> <span class="n">line</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="sa">b</span><span class="s1">&#39; &#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="n">keyword</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">keyword</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">whitelist</span>

    <span class="n">fields</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">valid</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">consensus</span><span class="p">,</span> <span class="n">header</span> <span class="o">=</span> <span class="n">scrap</span><span class="p">(</span><span class="n">consensus</span><span class="p">,</span> <span class="n">end_of_field</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">header</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">consensus</span><span class="p">,</span> <span class="n">fields</span> <span class="k">if</span> <span class="n">valid</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="n">valid</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="sa">b</span><span class="s1">&#39; &#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">header</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="s1">&#39;utf8&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">keyword</span><span class="p">,</span> <span class="n">content</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">keyword</span> <span class="o">==</span> <span class="s1">&#39;directory-footer&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Expect </span><span class="si">{}</span><span class="s1"> as first field!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">keyword</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">keyword</span> <span class="o">==</span> <span class="s1">&#39;bandwidth-weights&#39;</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">parse_params</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">keyword</span> <span class="o">==</span> <span class="s1">&#39;directory-signature&#39;</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">algorithm</span><span class="p">,</span> <span class="n">identity</span><span class="p">,</span> <span class="n">signing_key_digest</span> <span class="o">=</span> <span class="n">content</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">algorithm</span> <span class="o">=</span> <span class="s1">&#39;sha1&#39;</span>
                <span class="n">identity</span><span class="p">,</span> <span class="n">signing_key_digest</span> <span class="o">=</span> <span class="n">content</span>

            <span class="n">content</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;Algorithm&#39;</span><span class="p">:</span> <span class="n">algorithm</span><span class="p">,</span>
                <span class="s1">&#39;identity&#39;</span><span class="p">:</span> <span class="n">identity</span><span class="p">,</span>
                <span class="s1">&#39;signing-key-digest&#39;</span><span class="p">:</span> <span class="n">signing_key_digest</span><span class="p">}</span>

            <span class="n">consensus</span><span class="p">,</span> <span class="n">signature</span> <span class="o">=</span> <span class="n">scrap_signature</span><span class="p">(</span><span class="n">consensus</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">signature</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">signature</span> <span class="o">=</span> <span class="n">parse_base64</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">signature</span><span class="p">,</span> <span class="s1">&#39;utf8&#39;</span><span class="p">))</span>
                <span class="n">content</span><span class="p">[</span><span class="s1">&#39;signature&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">signature</span>

            <span class="k">if</span> <span class="n">keyword</span> <span class="o">+</span> <span class="s1">&#39;s&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
                <span class="n">fields</span><span class="p">[</span><span class="n">keyword</span> <span class="o">+</span> <span class="s1">&#39;s&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">fields</span><span class="p">[</span><span class="n">keyword</span> <span class="o">+</span> <span class="s1">&#39;s&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">fields</span><span class="p">[</span><span class="n">keyword</span><span class="p">]</span> <span class="o">=</span> <span class="n">content</span>
    <span class="k">return</span> <span class="n">consensus</span><span class="p">,</span> <span class="n">fields</span></div>


<div class="viewcode-block" id="parse"><a class="viewcode-back" href="../../lightnion.html#lightnion.consensus.parse">[docs]</a><span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="n">consensus</span><span class="p">,</span> <span class="n">flavor</span><span class="o">=</span><span class="s1">&#39;unflavored&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse a raw consensus with the given flavor, then returns sanitized</span>
<span class="sd">        entries as a python dictionary.</span>

<span class="sd">        :param str consensus: input to be processed</span>
<span class="sd">        :param str flavor: consensus flavor (&#39;unflavored&#39; or &#39;microdesc&#39;)</span>

<span class="sd">        :returns: a python dictionary</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">flavor</span><span class="o">=</span><span class="n">flavor</span><span class="p">)</span>

    <span class="n">consensus</span><span class="p">,</span> <span class="n">http</span> <span class="o">=</span> <span class="n">consume_http</span><span class="p">(</span><span class="n">consensus</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">http</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fields</span><span class="p">[</span><span class="s1">&#39;http&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">http</span>

    <span class="n">consensus</span><span class="p">,</span> <span class="n">headers</span> <span class="o">=</span> <span class="n">consume_headers</span><span class="p">(</span><span class="n">consensus</span><span class="p">,</span> <span class="n">flavor</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">headers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fields</span><span class="p">[</span><span class="s1">&#39;headers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">headers</span>

    <span class="n">consensus</span><span class="p">,</span> <span class="n">dir_sources</span> <span class="o">=</span> <span class="n">consume_dir_sources</span><span class="p">(</span><span class="n">consensus</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dir_sources</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fields</span><span class="p">[</span><span class="s1">&#39;dir-sources&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dir_sources</span>

    <span class="n">consensus</span><span class="p">,</span> <span class="n">routers</span> <span class="o">=</span> <span class="n">consume_routers</span><span class="p">(</span><span class="n">consensus</span><span class="p">,</span> <span class="n">flavor</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">routers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fields</span><span class="p">[</span><span class="s1">&#39;routers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">routers</span>

    <span class="n">consensus</span><span class="p">,</span> <span class="n">footer</span> <span class="o">=</span> <span class="n">consume_footer</span><span class="p">(</span><span class="n">consensus</span><span class="p">,</span> <span class="n">flavor</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">footer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fields</span><span class="p">[</span><span class="s1">&#39;footer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">footer</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="s1">&#39;headers&#39;</span> <span class="ow">in</span> <span class="n">fields</span>
            <span class="ow">and</span> <span class="s1">&#39;dir-sources&#39;</span> <span class="ow">in</span> <span class="n">fields</span>
            <span class="ow">and</span> <span class="s1">&#39;routers&#39;</span> <span class="ow">in</span> <span class="n">fields</span>
            <span class="ow">and</span> <span class="s1">&#39;footer&#39;</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Missing entry: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">fields</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">fields</span><span class="p">,</span> <span class="n">consensus</span></div>


<div class="viewcode-block" id="extract_date"><a class="viewcode-back" href="../../lightnion.html#lightnion.consensus.extract_date">[docs]</a><span class="k">def</span> <span class="nf">extract_date</span><span class="p">(</span><span class="n">consensus</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieve the value from a date field as a datetime object.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> [^</span><span class="se">\n</span><span class="s1">]+&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">field</span><span class="p">))</span>
    <span class="n">found</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">consensus</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">found</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Field </span><span class="si">{}</span><span class="s1"> not found in consensus.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">field</span><span class="p">))</span>

    <span class="n">date_s</span> <span class="o">=</span> <span class="n">consensus</span><span class="p">[</span><span class="n">found</span><span class="o">.</span><span class="n">start</span><span class="p">():</span><span class="n">found</span><span class="o">.</span><span class="n">end</span><span class="p">()]</span>
    <span class="n">date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">date_s</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> %Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">field</span><span class="p">))</span>
    <span class="n">date</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">date</span></div>


<div class="viewcode-block" id="extract_nodes_digests_unflavored"><a class="viewcode-back" href="../../lightnion.html#lightnion.consensus.extract_nodes_digests_unflavored">[docs]</a><span class="k">def</span> <span class="nf">extract_nodes_digests_unflavored</span><span class="p">(</span><span class="n">consensus_raw</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Retrieve a list of the digests of all routers in the consensus.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># We retrieve the third fields of the lines looking like that:</span>
    <span class="c1">#r VSIFskylab AD14gl4Llgnuz/Xk4FKXF3cuU8c 3VZwLdY0Et7vqUbqDdXg3WGGHCw 2020-01-12 23:47:04 104.218.63.73 443 80</span>
    <span class="n">digests_raw</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^r [^ ]+ [^ ]+ ([^ ]+)&#39;</span><span class="p">,</span> <span class="n">consensus_raw</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
    <span class="n">digests_bytes</span> <span class="o">=</span> <span class="p">[</span><span class="n">b64decode</span><span class="p">(</span><span class="n">digest</span> <span class="o">+</span> <span class="s1">&#39;====&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">digest</span> <span class="ow">in</span> <span class="n">digests_raw</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">digests_bytes</span></div>


<div class="viewcode-block" id="extract_nodes_digests_micro"><a class="viewcode-back" href="../../lightnion.html#lightnion.consensus.extract_nodes_digests_micro">[docs]</a><span class="k">def</span> <span class="nf">extract_nodes_digests_micro</span><span class="p">(</span><span class="n">consensus_raw</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Retrieve a list of the digests of all routers in the consensus.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># We retrieve the third fields of the lines looking like that:</span>
    <span class="c1">#m v7E0VcMnwVepVUh+j193lrbqbWOg26g9hXOBwSYv32I</span>
    <span class="n">digests_raw</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^m ([^\n]+)&#39;</span><span class="p">,</span> <span class="n">consensus_raw</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
    <span class="n">digests_bytes</span> <span class="o">=</span> <span class="p">[</span><span class="n">digest</span> <span class="k">for</span> <span class="n">digest</span> <span class="ow">in</span> <span class="n">digests_raw</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">digests_bytes</span></div>


<div class="viewcode-block" id="download"><a class="viewcode-back" href="../../lightnion.html#lightnion.consensus.download">[docs]</a><span class="k">def</span> <span class="nf">download</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">flavor</span><span class="o">=</span><span class="s1">&#39;microdesc&#39;</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">flavor</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;unflavored&#39;</span><span class="p">,</span> <span class="s1">&#39;microdesc&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s1">&#39;Consensus flavor &quot;</span><span class="si">{}</span><span class="s1">&quot; not supported.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flavor</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">cache</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">state</span><span class="p">,</span> <span class="n">lnn</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">consensus</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">flavor</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="n">endpoint</span> <span class="o">=</span> <span class="s1">&#39;/tor/status-vote/current/consensus&#39;</span>
    <span class="k">if</span> <span class="n">flavor</span> <span class="o">==</span> <span class="s1">&#39;microdesc&#39;</span><span class="p">:</span>
        <span class="n">endpoint</span> <span class="o">+=</span> <span class="s1">&#39;-microdesc&#39;</span>

    <span class="n">ip</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">:</span><span class="si">%d</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span><span class="mi">7000</span><span class="p">)</span> <span class="c1">#for real tor, change to 9051</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="n">get_signing_keys_info</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>
    <span class="n">state</span><span class="p">,</span> <span class="n">cons</span> <span class="o">=</span> <span class="n">lnn</span><span class="o">.</span><span class="n">hop</span><span class="o">.</span><span class="n">directory_query</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">)</span>

    <span class="n">cons_original</span> <span class="o">=</span> <span class="n">cons</span>
    <span class="n">cons</span><span class="p">,</span> <span class="n">http</span> <span class="o">=</span> <span class="n">consume_http</span><span class="p">(</span><span class="n">cons</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">flavor</span> <span class="o">!=</span> <span class="s1">&#39;microdesc&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lnn</span><span class="o">.</span><span class="n">signature</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">cons</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="n">keys</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Consensus Verification Failed&#39;</span><span class="p">)</span>

    <span class="n">consensus</span><span class="p">,</span> <span class="n">remaining</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="n">cons_original</span><span class="p">,</span> <span class="n">flavor</span><span class="o">=</span><span class="n">flavor</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">consensus</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">remaining</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">remaining</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Unable to parse downloaded consensus!&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">cache</span><span class="p">:</span>
        <span class="n">lnn</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">consensus</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">consensus</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">state</span><span class="p">,</span> <span class="n">consensus</span></div>


<div class="viewcode-block" id="download_direct"><a class="viewcode-back" href="../../lightnion.html#lightnion.consensus.download_direct">[docs]</a><span class="k">def</span> <span class="nf">download_direct</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">flavor</span><span class="o">=</span><span class="s1">&#39;microdesc&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Retrieve consensus via a direct HTTP connection.</span>
<span class="sd">    :param hostname: host name of the node from which to retrieve the consensus.</span>
<span class="sd">    :param port: port of the node from which to retrieve the consensus.</span>
<span class="sd">    :param flavor: flavour of the consensus to retrieve.</span>
<span class="sd">    :param cache: if the retrieved consensus should put in the cache.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">flavor</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;unflavored&#39;</span><span class="p">,</span> <span class="s1">&#39;microdesc&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s1">&#39;Consensus flavor &quot;</span><span class="si">{}</span><span class="s1">&quot; not supported.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flavor</span><span class="p">))</span>

    <span class="n">endpoint</span> <span class="o">=</span> <span class="s1">&#39;consensus-microdesc&#39;</span> <span class="k">if</span> <span class="n">flavor</span> <span class="o">==</span> <span class="s1">&#39;microdesc&#39;</span> <span class="k">else</span> <span class="s1">&#39;consensus&#39;</span>
    <span class="n">uri</span> <span class="o">=</span> <span class="s1">&#39;http://</span><span class="si">%s</span><span class="s1">:</span><span class="si">%d</span><span class="s1">/tor/status-vote/current/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">)</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
    <span class="n">cons</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

    <span class="n">ip</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">:</span><span class="si">%d</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span><span class="n">port</span><span class="p">)</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="n">get_signing_keys_info</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">flavor</span> <span class="o">!=</span> <span class="s1">&#39;microdesc&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lnn</span><span class="o">.</span><span class="n">signature</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">cons</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="n">keys</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Consensus Verification Failed&#39;</span><span class="p">)</span>

    <span class="n">consensus</span><span class="p">,</span> <span class="n">remaining</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="n">cons</span><span class="p">,</span> <span class="n">flavor</span><span class="o">=</span><span class="n">flavor</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">consensus</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">remaining</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">remaining</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Unable to parse downloaded consensus!&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">consensus</span><span class="p">,</span> <span class="n">keys</span></div>

<div class="viewcode-block" id="download_raw"><a class="viewcode-back" href="../../lightnion.html#lightnion.consensus.download_raw">[docs]</a><span class="k">def</span> <span class="nf">download_raw</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">flavor</span><span class="o">=</span><span class="s1">&#39;unflavored&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Retrieve raw consensus via a direct HTTP connection.</span>
<span class="sd">    :param hostname: host name of the node from which to retrieve the consensus.</span>
<span class="sd">    :param port: port of the node from which to retrieve the consensus.</span>
<span class="sd">    :param flavor: flavour of the consensus to retrieve.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">flavor</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;unflavored&#39;</span><span class="p">,</span> <span class="s1">&#39;microdesc&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s1">&#39;Consensus flavor &quot;</span><span class="si">{}</span><span class="s1">&quot; not supported.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flavor</span><span class="p">))</span>

    <span class="n">endpoint</span> <span class="o">=</span> <span class="s1">&#39;consensus-microdesc&#39;</span> <span class="k">if</span> <span class="n">flavor</span> <span class="o">==</span> <span class="s1">&#39;microdesc&#39;</span> <span class="k">else</span> <span class="s1">&#39;consensus&#39;</span>
    <span class="n">uri</span> <span class="o">=</span> <span class="s1">&#39;http://</span><span class="si">%s</span><span class="s1">:</span><span class="si">%d</span><span class="s1">/tor/status-vote/current/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">)</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
    <span class="n">cons</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">cons</span></div>

<div class="viewcode-block" id="load"><a class="viewcode-back" href="../../lightnion.html#lightnion.consensus.load">[docs]</a><span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Load the consensus from a file</span>
<span class="sd">    :param file_name: the name of the file in consensus_file</span>
<span class="sd">    :param cache: if we cache the newly downloaded consensus</span>
<span class="sd">    :return: the parsed consensus&quot;&quot;&quot;</span>

    <span class="n">abs_path</span> <span class="o">=</span> <span class="s2">&quot;/vagrant/consensus_files/&quot;</span><span class="o">+</span><span class="n">file_name</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">abs_path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">cache</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">lnn</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">consensus</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;unflavored&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">abs_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">answer</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

    <span class="n">consensus</span><span class="p">,</span> <span class="n">remaining</span> <span class="o">=</span> <span class="n">consume_routers</span><span class="p">(</span><span class="n">answer</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">consensus</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">remaining</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">remaining</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Unable to parse downloaded consensus!&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">cache</span><span class="p">:</span>
        <span class="n">lnn</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">consensus</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">consensus</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">consensus</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Matthieu Daumas, Ricardo Ferreira Ribeiro, Laurent Girod, Shivram N Gowtham, Wouter Lueks, Carmela Troncoso, Chia-An Yu

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>